name: "Performance comparison"

on:
  workflow_dispatch:
  workflow_call:

env:
  GIT_CONFIG_GLOBAL: "/root/.gitconfig" # fix path in container (https://github.com/actions/runner/issues/2033)

jobs:
  compare-performance:
    if: ${{ github.event_name == 'pull_request' }}
    runs-on: "ubuntu-latest"
    container:
      image: "ghcr.io/tarantool/sdvg-ci:0.0.2"

    steps:
      - uses: "actions/checkout@v4"

      - name: "Install requirements"
        run: "pip install -r ./build/ci/requirements.txt"

      - name: "Try fetch cached benchmark result from master branch"
        id: "cache-benchmark"
        uses: "actions/cache/restore@v4"
        with:
          key: "benchmark-master"
          path: "benchmark-master.txt"

      - name: "Fetch master branch"
        if: ${{ steps.cache-benchmark.outputs.cache-hit != 'true' }}
        uses: "actions/checkout@v4"
        with:
          ref: ${{ github.event.repository.default_branch }}
          path: "master_branch"

      - name: "Create master benchmark"
        if: ${{ steps.cache-benchmark.outputs.cache-hit != 'true' }}
        working-directory: "master_branch"
        run: make test/performance > ../benchmark-master.txt

      - name: "Update cache with benchmark-master.txt"
        uses: "actions/cache/save@v4"
        with:
          key: "benchmark-master"
          path: "benchmark-master.txt"

      - name: "Run benchmarks on PR branch"
        run: make test/performance > benchmark-pr.txt

      - name: "Get comparison results"
        run: |
          echo -e \
            "# Perf tests comparison: \`${{ github.event.repository.default_branch }}\` VS \`${{ github.ref_name }}\`\n" \
            > performance-report.md
          python ./build/ci/compare_benchmarks.py \
            benchmark-master.txt benchmark-pr.txt \
            --alert-threshold 7 \
            --aggregation mean \
            >> performance-report.md
          cat performance-report.md >> $GITHUB_STEP_SUMMARY

      - name: "Save comparison report"
        uses: "actions/cache/save@v4"
        with:
          key: "perf-report-pr-${{ github.event.pull_request.number }}"
          path: "performance-report.md"

  update-master-cache:
    if: ${{ github.ref_name == github.event.repository.default_branch }}
    runs-on: "ubuntu-latest"
    container:
      image: "ghcr.io/tarantool/sdvg-ci:0.0.2"

    steps:
      - uses: "actions/checkout@v4"

      - name: "Create master benchmark"
        if: ${{ steps.cache-benchmark.outputs.cache-hit != 'true' }}
        run: make test/performance > ./benchmark-master.txt

      - name: "Save benchmark-master.txt to cache"
        if: ${{ steps.cache-benchmark.outputs.cache-hit != 'true' }}
        uses: "actions/cache/save@v4"
        with:
          key: "benchmark-master"
          path: "benchmark-master.txt"
